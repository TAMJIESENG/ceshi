<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´§æ€¥ä¿®å¤å·¥å…·</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #fff3cd;
            border: 2px solid #ffeaa7;
        }
        .alert {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>ğŸš¨ ç´§æ€¥ä¿®å¤å·¥å…·</h1>
    
    <div class="alert">
        <strong>âš ï¸ è­¦å‘Šï¼š</strong> è¿™ä¸ªå·¥å…·ç”¨äºè§£å†³ç™»å½•å¤±è´¥çš„ç´§æ€¥æƒ…å†µã€‚å®ƒä¼šå¼ºåˆ¶é‡ç½®æ‰€æœ‰ç›¸å…³è®¾ç½®ã€‚
    </div>

    <button onclick="emergencyFix()" class="success">ğŸ”§ æ‰§è¡Œç´§æ€¥ä¿®å¤</button>
    <button onclick="checkStatus()">ğŸ“Š æ£€æŸ¥å½“å‰çŠ¶æ€</button>
    <button onclick="testDirectLogin()">ğŸ§ª æµ‹è¯•ç›´æ¥ç™»å½•</button>

    <div id="output"></div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `step`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            output.appendChild(div);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function emergencyFix() {
            clearOutput();
            log('ğŸš¨ å¼€å§‹ç´§æ€¥ä¿®å¤...', 'warning');
            
            try {
                // 1. æ¸…é™¤ç»´æŠ¤æ¨¡å¼
                localStorage.removeItem('maintenance_status');
                log('âœ… æ¸…é™¤ç»´æŠ¤æ¨¡å¼è®¾ç½®');

                // 2. æ¸…é™¤å½“å‰ä¼šè¯
                localStorage.removeItem('user_token');
                localStorage.removeItem('user_data');
                log('âœ… æ¸…é™¤å½“å‰ä¼šè¯');

                // 3. é‡ç½®ç®¡ç†å‘˜è´¦å·
                let users = JSON.parse(localStorage.getItem('all_users') || '[]');
                let adminIndex = users.findIndex(u => u.role === 'admin');
                
                const correctAdmin = {
                    id: 1,
                    username: 'admin',
                    email: 'admin@example.com',
                    password: 'admin123', // ç¡®ä¿æ˜æ–‡å¯†ç å­˜åœ¨
                    role: 'admin',
                    registerTime: new Date().toLocaleString('zh-CN'),
                    balance: 10000,
                    level: 'SVIP',
                    twoFactorEnabled: false,
                    emailVerified: true,
                    loginAttempts: 0
                };

                if (adminIndex >= 0) {
                    users[adminIndex] = correctAdmin;
                    log('âœ… é‡ç½®ç°æœ‰ç®¡ç†å‘˜è´¦å·');
                } else {
                    users.push(correctAdmin);
                    log('âœ… åˆ›å»ºæ–°ç®¡ç†å‘˜è´¦å·');
                }

                localStorage.setItem('all_users', JSON.stringify(users));

                // 4. æ¸…é™¤æ‰€æœ‰é”™è¯¯è®°å½•
                localStorage.removeItem('audit_logs');
                log('âœ… æ¸…é™¤å®¡è®¡æ—¥å¿—');

                // 5. åˆ›å»ºæœ€å°åŒ–æµ‹è¯•æ•°æ®
                const testCards = [{
                    id: 1,
                    cardNumber: 'TEST123456',
                    cardType: 'æœˆå¡',
                    value: 'Â¥29.90',
                    status: 'unused',
                    createTime: new Date().toLocaleString('zh-CN'),
                    useTime: null
                }];
                localStorage.setItem('all_cards', JSON.stringify(testCards));
                log('âœ… åˆ›å»ºæµ‹è¯•å¡å¯†');

                // 6. è®¾ç½®åˆå§‹åŒ–æ ‡è®°
                localStorage.setItem('emergency_fixed', 'true');
                localStorage.setItem('emergency_fix_time', new Date().toISOString());

                log('ğŸ‰ ç´§æ€¥ä¿®å¤å®Œæˆï¼', 'success');
                log('ğŸ“ ç®¡ç†å‘˜è´¦å·: admin', 'success');
                log('ğŸ“ ç®¡ç†å‘˜å¯†ç : admin123', 'success');
                log('âš ï¸ è¯·åˆ·æ–°ä¸»åº”ç”¨é¡µé¢å¹¶é‡æ–°ç™»å½•', 'warning');

            } catch (error) {
                log(`âŒ ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function checkStatus() {
            clearOutput();
            log('ğŸ“Š æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            try {
                // æ£€æŸ¥ç»´æŠ¤æ¨¡å¼
                const maintenanceStatus = localStorage.getItem('maintenance_status');
                if (maintenanceStatus) {
                    const status = JSON.parse(maintenanceStatus);
                    log(`âš ï¸ ç»´æŠ¤æ¨¡å¼çŠ¶æ€: ${status.isActive ? 'å¯ç”¨' : 'ç¦ç”¨'}`, status.isActive ? 'warning' : 'success');
                } else {
                    log('âœ… ç»´æŠ¤æ¨¡å¼: æœªè®¾ç½®ï¼ˆæ­£å¸¸ï¼‰');
                }

                // æ£€æŸ¥ç”¨æˆ·æ•°æ®
                const users = JSON.parse(localStorage.getItem('all_users') || '[]');
                log(`ğŸ‘¥ ç”¨æˆ·æ€»æ•°: ${users.length}`);
                
                const admin = users.find(u => u.role === 'admin');
                if (admin) {
                    log(`âœ… ç®¡ç†å‘˜è´¦å·å­˜åœ¨: ${admin.username}`);
                    log(`ğŸ“ ç®¡ç†å‘˜æ˜æ–‡å¯†ç : ${admin.password || 'æœªè®¾ç½®'}`);
                    log(`ğŸ” ç®¡ç†å‘˜å“ˆå¸Œå¯†ç : ${admin.passwordHash ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    log(`ğŸ”‘ ç®¡ç†å‘˜ç›å€¼: ${admin.passwordSalt ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                } else {
                    log('âŒ ç®¡ç†å‘˜è´¦å·ä¸å­˜åœ¨');
                }

                // æ£€æŸ¥ä¼šè¯
                const token = localStorage.getItem('user_token');
                const userData = localStorage.getItem('user_data');
                log(`ğŸ” å½“å‰ä»¤ç‰Œ: ${token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                log(`ğŸ‘¤ å½“å‰ç”¨æˆ·æ•°æ®: ${userData ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);

                // æ£€æŸ¥ç´§æ€¥ä¿®å¤è®°å½•
                const emergencyFixed = localStorage.getItem('emergency_fixed');
                const fixTime = localStorage.getItem('emergency_fix_time');
                if (emergencyFixed) {
                    log(`ğŸ”§ ä¸Šæ¬¡ç´§æ€¥ä¿®å¤æ—¶é—´: ${new Date(fixTime).toLocaleString()}`);
                }

                log('ğŸ“Š çŠ¶æ€æ£€æŸ¥å®Œæˆ');

            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testDirectLogin() {
            clearOutput();
            log('ğŸ§ª æµ‹è¯•ç›´æ¥ç™»å½•é€»è¾‘...');
            
            try {
                const credentials = { username: 'admin', password: 'admin123' };
                
                // æ­¥éª¤1: æ£€æŸ¥ç”¨æˆ·å­˜åœ¨
                const users = JSON.parse(localStorage.getItem('all_users') || '[]');
                const foundUser = users.find(u => u.username === credentials.username);
                
                if (!foundUser) {
                    log('âŒ ç”¨æˆ·ä¸å­˜åœ¨');
                    return;
                }
                log('âœ… ç”¨æˆ·å­˜åœ¨');

                // æ­¥éª¤2: æ£€æŸ¥ç»´æŠ¤æ¨¡å¼
                const maintenanceStatus = localStorage.getItem('maintenance_status');
                let isMaintenanceActive = false;
                if (maintenanceStatus) {
                    const status = JSON.parse(maintenanceStatus);
                    isMaintenanceActive = status.isActive;
                    log(`âš ï¸ ç»´æŠ¤æ¨¡å¼: ${isMaintenanceActive ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                } else {
                    log('âœ… ç»´æŠ¤æ¨¡å¼: æœªå¯ç”¨');
                }

                // æ­¥éª¤3: å¯†ç éªŒè¯
                let isPasswordValid = false;
                if (foundUser.password) {
                    isPasswordValid = foundUser.password === credentials.password;
                    log(`ğŸ” æ˜æ–‡å¯†ç éªŒè¯: ${isPasswordValid ? 'é€šè¿‡' : 'å¤±è´¥'}`);
                    log(`   å­˜å‚¨å¯†ç : "${foundUser.password}"`);
                    log(`   è¾“å…¥å¯†ç : "${credentials.password}"`);
                } else {
                    log('âŒ ç”¨æˆ·æ²¡æœ‰æ˜æ–‡å¯†ç ');
                }

                // æ­¥éª¤4: è§’è‰²æ£€æŸ¥
                if (foundUser.role === 'admin') {
                    log('âœ… ç®¡ç†å‘˜æƒé™ç¡®è®¤');
                } else {
                    log(`âš ï¸ ç”¨æˆ·è§’è‰²: ${foundUser.role}`);
                }

                // ç»“è®º
                if (isPasswordValid && foundUser.role === 'admin') {
                    log('ğŸ‰ ç™»å½•åº”è¯¥æˆåŠŸï¼', 'success');
                } else {
                    log('âŒ ç™»å½•ä¼šå¤±è´¥', 'error');
                    if (!isPasswordValid) log('  åŸå› : å¯†ç éªŒè¯å¤±è´¥');
                    if (foundUser.role !== 'admin') log('  åŸå› : éç®¡ç†å‘˜è§’è‰²');
                }

            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            setTimeout(checkStatus, 500);
        };
    </script>
</body>
</html>