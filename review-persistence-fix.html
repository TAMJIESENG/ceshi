<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论持久化保存修复</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .fix-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        .success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        
        .info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .before, .after {
            padding: 15px;
            border-radius: 6px;
        }
        
        .before {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .after {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        .step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .step-number {
            display: inline-block;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            margin-right: 15px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 3px 6px;
            border-radius: 4px;
            color: #856404;
            font-weight: 600;
        }
        
        .flow-diagram {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .flow-arrow {
            margin: 0 15px;
            color: #6c757d;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>💬 评论持久化保存修复</h1>
    
    <div class="fix-section success">
        <h3>✅ 问题已修复！</h3>
        <p><strong>问题：</strong>购买页面的用户评论无法持久化保存，刷新页面后评论消失。</p>
        <p><strong>解决：</strong>添加了完整的评论数据localStorage存储和加载机制，确保评论数据持久化保存。</p>
    </div>

    <div class="fix-section error">
        <h3>🐛 问题分析</h3>
        
        <h4>根本原因</h4>
        <p>评论提交后只更新了内存中的产品数据，没有保存到localStorage：</p>
        <div class="code">
const submitReview = async () => {
  // ... 创建评论对象 ...
  
  // ❌ 只添加到内存中
  currentReviewProduct.value.reviews.unshift(review)
  updateProductRating(currentReviewProduct.value)
  
  // ❌ 没有保存到localStorage，刷新页面数据丢失
  ElMessage.success('评价提交成功')
}
        </div>

        <h4>数据流问题</h4>
        <div class="flow-diagram">
            <div class="flow-step">
                <span>用户提交评论</span>
                <span class="flow-arrow">→</span>
                <span>添加到内存数组</span>
                <span class="flow-arrow">→</span>
                <span class="highlight">❌ 未保存到localStorage</span>
            </div>
            <div class="flow-step">
                <span>页面刷新</span>
                <span class="flow-arrow">→</span>
                <span>重新加载数据</span>
                <span class="flow-arrow">→</span>
                <span class="highlight">❌ 评论数据丢失</span>
            </div>
        </div>
    </div>

    <div class="fix-section">
        <h3>🔧 修复方案</h3>
        
        <div class="comparison">
            <div class="before">
                <h4>❌ 修复前</h4>
                <div class="code">
const submitReview = async () => {
  // 创建评论
  const review = { ... }
  
  // 只更新内存数据
  currentReviewProduct.value.reviews.unshift(review)
  updateProductRating(currentReviewProduct.value)
  
  ElMessage.success('评价提交成功')
  closeReviewDialog()
}

// 页面加载时
const loadData = () => {
  // 只加载产品数据，没有评论数据
  const savedProducts = localStorage.getItem('card_products')
  // ...
}
                </div>
            </div>
            
            <div class="after">
                <h4>✅ 修复后</h4>
                <div class="code">
const submitReview = async () => {
  // 创建评论
  const review = { ... }
  
  // 更新内存数据
  currentReviewProduct.value.reviews.unshift(review)
  updateProductRating(currentReviewProduct.value)
  
  // ✅ 保存评论数据到localStorage
  saveReviewsData()
  
  ElMessage.success('评价提交成功')
  closeReviewDialog()
}

// 页面加载时
const loadData = () => {
  // 加载产品数据
  // ...
  
  // ✅ 加载评论数据
  setTimeout(() => {
    loadReviewsData()
  }, 100)
}
                </div>
            </div>
        </div>

        <h4>详细修复步骤</h4>
        
        <div class="step">
            <span class="step-number">1</span>
            <strong>添加评论数据保存函数</strong>
            <div class="code">
// 保存评论数据到localStorage
const saveReviewsData = () => {
  try {
    console.log('=== 保存评论数据 ===')
    
    // 收集所有产品的评论数据
    const allReviewsData = {}
    
    // 从 products 数组中收集评论
    products.value.forEach(product => {
      if (product.reviews && product.reviews.length > 0) {
        allReviewsData[product.id] = {
          reviews: product.reviews,
          rating: product.rating,
          reviewCount: product.reviewCount
        }
      }
    })
    
    // 保存到localStorage
    localStorage.setItem('product_reviews', JSON.stringify(allReviewsData))
    console.log('评论数据保存成功，共', Object.keys(allReviewsData).length, '个产品有评论')
    
  } catch (error) {
    console.error('保存评论数据失败:', error)
    ElMessage.error('保存评论失败')
  }
}
            </div>
        </div>

        <div class="step">
            <span class="step-number">2</span>
            <strong>添加评论数据加载函数</strong>
            <div class="code">
// 从 localStorage 加载评论数据
const loadReviewsData = () => {
  try {
    console.log('=== 加载评论数据 ===')
    
    const savedReviews = localStorage.getItem('product_reviews')
    if (!savedReviews) {
      console.log('未找到已保存的评论数据')
      return
    }
    
    const reviewsData = JSON.parse(savedReviews)
    console.log('加载到', Object.keys(reviewsData).length, '个产品的评论数据')
    
    // 将评论数据分配给对应的产品
    products.value.forEach(product => {
      if (reviewsData[product.id]) {
        const reviewData = reviewsData[product.id]
        product.reviews = reviewData.reviews
        product.rating = reviewData.rating
        product.reviewCount = reviewData.reviewCount
        console.log(`恢复产品 ${product.id} ("${product.name}") 的评论:`, product.reviewCount, '条')
      }
    })
    
    console.log('评论数据加载完成')
    
  } catch (error) {
    console.error('加载评论数据失败:', error)
  }
}
            </div>
        </div>

        <div class="step">
            <span class="step-number">3</span>
            <strong>在评论提交后保存数据</strong>
            <div class="code">
const submitReview = async () => {
  // ... 评论创建和验证逻辑 ...
  
  // 将评价添加到产品的评价列表中
  if (!currentReviewProduct.value.reviews) {
    currentReviewProduct.value.reviews = []
  }
  currentReviewProduct.value.reviews.unshift(review)
  
  // 更新产品评分
  updateProductRating(currentReviewProduct.value)
  
  // ✅ 保存评论数据到localStorage
  saveReviewsData()

  ElMessage.success('评价提交成功')
  closeReviewDialog()
}
            </div>
        </div>

        <div class="step">
            <span class="step-number">4</span>
            <strong>在页面加载时恢复评论数据</strong>
            <div class="code">
const loadData = () => {
  try {
    // 加载专区数据
    // ...
    
    // 加载商品数据
    // ...
    
    console.log('💳 购买页面数据加载完成，专区数量:', zones.value.length)
    
    // ✅ 在所有数据加载完成后加载评论数据
    setTimeout(() => {
      loadReviewsData()
    }, 100)
    
  } catch (error) {
    console.error('加载数据失败:', error)
  }
}
            </div>
        </div>
    </div>

    <div class="fix-section warning">
        <h3>📋 测试步骤</h3>
        <ol>
            <li>打开浏览器控制台(F12) → Console选项卡</li>
            <li>访问购买卡密页面</li>
            <li>点击任意商品查看详情 → 切换到"用户评价"选项卡</li>
            <li>点击"写评价"按钮，填写评价内容并提交</li>
            <li>查看控制台日志，确认看到：</li>
            <div class="code">
=== 保存评论数据 ===
评论数据保存成功，共 1 个产品有评论
产品 123: 1 条评论，评分 5
            </div>
            <li>刷新页面，再次查看该商品的评价</li>
            <li>确认评论依然存在，控制台显示：</li>
            <div class="code">
=== 加载评论数据 ===
加载到 1 个产品的评论数据
恢复产品 123 ("商品名称") 的评论: 1 条
评论数据加载完成
            </div>
        </ol>
    </div>

    <div class="fix-section info">
        <h3>🔍 数据结构</h3>
        
        <h4>localStorage存储格式</h4>
        <div class="code">
// localStorage.getItem('product_reviews')
{
  "123": {
    "reviews": [
      {
        "id": 1640995200000,
        "productId": 123,
        "userId": "user123",
        "userName": "张三",
        "avatar": "/default-avatar.jpg",
        "rating": 5,
        "content": "商品很不错，服务态度很好！",
        "images": [],
        "date": "2024-01-01T10:00:00.000Z",
        "likes": 0,
        "isHelpful": false
      }
    ],
    "rating": 5.0,
    "reviewCount": 1
  }
}
        </div>

        <h4>产品对象结构</h4>
        <div class="code">
// product对象包含的评论相关字段
{
  "id": 123,
  "name": "商品名称",
  // ... 其他产品信息 ...
  
  "reviews": [...],        // 评论数组
  "rating": 5.0,           // 平均评分
  "reviewCount": 1         // 评论总数
}
        </div>
    </div>

    <div class="fix-section success">
        <h3>🎉 修复效果</h3>
        <ul>
            <li>✅ 评论提交后自动保存到localStorage</li>
            <li>✅ 页面刷新后评论数据完整恢复</li>
            <li>✅ 产品评分和评论数量正确计算</li>
            <li>✅ 详细的调试日志便于问题排查</li>
            <li>✅ 错误处理机制确保系统稳定</li>
            <li>✅ 支持多个产品的评论数据管理</li>
        </ul>
    </div>

    <div class="fix-section info">
        <h3>💡 技术细节</h3>
        
        <h4>为什么使用延迟加载</h4>
        <div class="code">
// 延迟加载评论数据，确保产品数据先加载完成
setTimeout(() => {
  loadReviewsData()
}, 100)

// 原因：
// 1. 产品数据需要先从localStorage加载
// 2. 评论数据依赖于产品对象的存在
// 3. 避免竞争条件导致的数据丢失
        </div>

        <h4>数据一致性保证</h4>
        <div class="code">
// 保存时收集所有产品的最新评论数据
products.value.forEach(product => {
  if (product.reviews && product.reviews.length > 0) {
    allReviewsData[product.id] = {
      reviews: product.reviews,      // 完整评论列表
      rating: product.rating,        // 实时计算的平均分
      reviewCount: product.reviewCount  // 实时计算的总数
    }
  }
})
        </div>

        <h4>错误处理机制</h4>
        <div class="code">
try {
  // 数据操作
  localStorage.setItem('product_reviews', JSON.stringify(allReviewsData))
} catch (error) {
  console.error('保存评论数据失败:', error)
  ElMessage.error('保存评论失败')  // 用户友好的错误提示
}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('💬 评论持久化修复测试页面已加载');
            
            // 页面动画
            const sections = document.querySelectorAll('.fix-section');
            sections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                section.style.transition = 'all 0.6s ease';
                
                setTimeout(() => {
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, index * 100);
            });

            console.log('📋 修复总结:');
            console.log('1. ✅ 添加saveReviewsData()保存函数');
            console.log('2. ✅ 添加loadReviewsData()加载函数');
            console.log('3. ✅ 在评论提交后调用保存函数');
            console.log('4. ✅ 在页面加载时调用加载函数');
            console.log('5. ✅ 完整的错误处理和调试日志');
            console.log('');
            console.log('🎯 现在用户评论可以持久化保存了！');
        });
    </script>
</body>
</html>