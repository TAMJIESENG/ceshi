<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表单验证修复测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .fix-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        .success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        
        .info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        
        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .step-number {
            display: inline-block;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            text-align: center;
            line-height: 28px;
            margin-right: 12px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            color: #856404;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <h1>🎯 表单验证问题修复完成</h1>
    
    <div class="fix-section success">
        <h3>✅ 问题已解决！</h3>
        <p><strong>核心问题：</strong>表单验证规则要求<code>icon</code>字段必填，但用户选择自定义图片时会清空该字段。</p>
        <p><strong>解决方案：</strong>使用自定义验证函数，确保至少选择了emoji图标或自定义图标中的一种。</p>
    </div>

    <div class="fix-section info">
        <h3>🔍 问题分析</h3>
        
        <div class="step">
            <span class="step-number">1</span>
            <strong>发现验证失败</strong>
            <p>控制台错误显示"表单验证失败"，说明Element Plus的表单验证阻止了保存操作。</p>
            <div class="code">
// 原验证规则（有问题的）
icon: [
  { required: true, message: '请选择专区图标', trigger: 'change' }
]

// 问题：当用户上传自定义图片时
zoneForm.icon = ''        // ❌ 清空了，导致验证失败
zoneForm.customIcon = 'data:image/png;base64,xxx' // ✅ 有数据但不被验证
            </div>
        </div>

        <div class="step">
            <span class="step-number">2</span>
            <strong>设计新的验证策略</strong>
            <p>既然用户可以选择emoji图标或自定义图标，验证逻辑应该允许其中任意一种。</p>
            <div class="code">
// 新的自定义验证函数
const validateIcon = (rule, value, callback) => {
  const hasEmojiIcon = zoneForm.icon && zoneForm.icon.trim() !== ''
  const hasCustomIcon = zoneForm.customIcon && zoneForm.customIcon.trim() !== ''
  
  if (!hasEmojiIcon && !hasCustomIcon) {
    callback(new Error('请选择emoji图标或上传自定义图标'))
  } else {
    callback() // 验证通过
  }
}
            </div>
        </div>

        <div class="step">
            <span class="step-number">3</span>
            <strong>应用新验证规则</strong>
            <div class="code">
// 修复后的验证规则
icon: [
  { validator: validateIcon, trigger: 'change' }
]
            </div>
            <p>使用<code>validator</code>替代简单的<code>required</code>规则，实现更灵活的验证逻辑。</p>
        </div>

        <div class="step">
            <span class="step-number">4</span>
            <strong>手动触发验证更新</strong>
            <p>当用户上传图片或选择emoji时，手动触发表单验证以实时更新状态。</p>
            <div class="code">
// 图片上传成功后
ElMessage.success('图片上传成功！现在可以保存了')
if (zoneFormRef.value) {
  zoneFormRef.value.validateField('icon') // 🔄 重新验证icon字段
}

// emoji选择后
const selectEmojiIcon = (icon) => {
  zoneForm.icon = icon
  zoneForm.customIcon = ''
  iconType.value = 'emoji'
  
  if (zoneFormRef.value) {
    zoneFormRef.value.validateField('icon') // 🔄 重新验证icon字段
  }
}
            </div>
        </div>
    </div>

    <div class="fix-section">
        <h3>🛠️ 完整修复内容</h3>
        
        <h4>1. 自定义验证函数</h4>
        <div class="code">
const validateIcon = (rule, value, callback) => {
  console.log('验证图标:', {
    iconType: iconType.value,
    icon: zoneForm.icon,
    customIcon: zoneForm.customIcon ? '有数据' : '无数据',
    customIconLength: zoneForm.customIcon ? zoneForm.customIcon.length : 0
  })
  
  // 检查是否有emoji图标或自定义图标
  const hasEmojiIcon = zoneForm.icon && zoneForm.icon.trim() !== ''
  const hasCustomIcon = zoneForm.customIcon && zoneForm.customIcon.trim() !== ''
  
  if (!hasEmojiIcon && !hasCustomIcon) {
    console.error('图标验证失败：既没有emoji图标也没有自定义图标')
    callback(new Error('请选择emoji图标或上传自定义图标'))
  } else {
    console.log('图标验证通过')
    callback()
  }
}
        </div>

        <h4>2. 更新验证规则</h4>
        <div class="code">
const zoneRules = {
  name: [
    { required: true, message: '请输入专区名称', trigger: 'blur' },
    { min: 2, max: 20, message: '名称长度在 2 到 20 个字符', trigger: 'blur' }
  ],
  icon: [
    { validator: validateIcon, trigger: 'change' } // ✅ 使用自定义验证
  ],
  description: [
    { required: true, message: '请输入专区描述', trigger: 'blur' },
    { max: 100, message: '描述不能超过100个字符', trigger: 'blur' }
  ]
}
        </div>

        <h4>3. 实时验证触发</h4>
        <div class="code">
// 图片上传成功后触发验证
reader.onload = (e) => {
  // ...处理图片数据...
  
  ElMessage.success('图片上传成功！现在可以保存了')
  
  // 手动触发表单验证更新
  if (zoneFormRef.value) {
    console.log('手动触发icon字段验证...')
    zoneFormRef.value.validateField('icon')
  }
}

// emoji选择后触发验证
const selectEmojiIcon = (icon) => {
  console.log('选择emoji图标:', icon)
  zoneForm.icon = icon
  zoneForm.customIcon = ''
  iconType.value = 'emoji'
  
  // 手动触发表单验证更新
  if (zoneFormRef.value) {
    console.log('手动触发icon字段验证...')
    zoneFormRef.value.validateField('icon')
  }
}
        </div>
    </div>

    <div class="fix-section warning">
        <h3>📋 测试步骤</h3>
        <ol>
            <li>进入管理后台 → 专区管理 → 编辑专区或创建专区</li>
            <li>填写必要信息（名称、描述）</li>
            <li>测试场景1：<span class="highlight">选择emoji图标</span> → 点击保存 → 应该成功</li>
            <li>测试场景2：<span class="highlight">上传自定义图片</span> → 点击保存 → 应该成功</li>
            <li>测试场景3：<span class="highlight">既不选emoji也不上传图片</span> → 点击保存 → 应该提示"请选择emoji图标或上传自定义图标"</li>
            <li>打开浏览器控制台查看详细的验证日志</li>
        </ol>
    </div>

    <div class="fix-section success">
        <h3>🎉 预期结果</h3>
        <ul>
            <li>✅ 上传图片后可以正常保存</li>
            <li>✅ 选择emoji图标后可以正常保存</li>
            <li>✅ 没有选择任何图标时会显示友好的错误提示</li>
            <li>✅ 控制台显示详细的验证过程日志</li>
            <li>✅ 表单验证不再阻止保存操作</li>
            <li>✅ 专区数据正确保存到localStorage</li>
            <li>✅ 页面刷新后自定义图标正常显示</li>
        </ul>
    </div>

    <div class="fix-section info">
        <h3>🔬 调试信息</h3>
        <p>在浏览器控制台中，你会看到以下调试信息：</p>
        <ul>
            <li><code>验证图标: {iconType: "custom", icon: "", customIcon: "有数据", ...}</code></li>
            <li><code>图标验证通过</code> 或 <code>图标验证失败：...</code></li>
            <li><code>手动触发icon字段验证...</code></li>
            <li><code>表单验证结果: true</code></li>
        </ul>
        
        <h4>如果仍然有问题：</h4>
        <div class="code">
// 在控制台运行这个命令检查当前表单状态
console.log('当前表单数据:', {
  name: zoneForm?.name,
  icon: zoneForm?.icon,
  customIcon: zoneForm?.customIcon ? '有数据' : '无数据',
  iconType: iconType?.value
})
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 表单验证修复测试页面已加载');
            
            // 添加页面动画
            const sections = document.querySelectorAll('.fix-section');
            sections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                section.style.transition = 'all 0.6s ease';
                
                setTimeout(() => {
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, index * 150);
            });

            console.log('📋 修复内容总结:');
            console.log('1. ✅ 移除了icon字段的简单required验证');
            console.log('2. ✅ 添加了自定义validateIcon函数');
            console.log('3. ✅ 在图片上传和emoji选择后手动触发验证');
            console.log('4. ✅ 增加了详细的调试日志');
            console.log('');
            console.log('现在图片上传和保存应该完全正常了！');
        });
    </script>
</body>
</html>