<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•å¤±è´¥è¯Šæ–­å·¥å…·</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .diagnostic-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .success { color: #67C23A; font-weight: bold; }
        .error { color: #F56C6C; font-weight: bold; }
        .warning { color: #E6A23C; font-weight: bold; }
        .info { color: #409EFF; font-weight: bold; }
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        button:hover { background: #337ecc; }
        button.danger { background: #F56C6C; }
        button.danger:hover { background: #e54545; }
        pre {
            background: #f0f0f0;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .step {
            border-left: 4px solid #409EFF;
            padding-left: 12px;
            margin: 10px 0;
        }
        .step.error {
            border-left-color: #F56C6C;
        }
        .step.success {
            border-left-color: #67C23A;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ç™»å½•å¤±è´¥è¯Šæ–­å·¥å…·</h1>
    
    <div class="diagnostic-card">
        <h2>ğŸš€ å¿«é€Ÿä¿®å¤</h2>
        <button onclick="quickFix()">ä¸€é”®ä¿®å¤æ‰€æœ‰é—®é¢˜</button>
        <button onclick="resetEverything()" class="danger">å®Œå…¨é‡ç½®ç³»ç»Ÿ</button>
        <div id="quickFixResult"></div>
    </div>

    <div class="diagnostic-card">
        <h2>ğŸ“Š å®Œæ•´è¯Šæ–­</h2>
        <button onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <div id="diagnosticResult"></div>
    </div>

    <div class="diagnostic-card">
        <h2>ğŸ§ª æ¨¡æ‹Ÿç™»å½•æµ‹è¯•</h2>
        <button onclick="simulateLogin()">æ¨¡æ‹Ÿå®Œæ•´ç™»å½•æµç¨‹</button>
        <div id="simulationResult"></div>
    </div>

    <div class="diagnostic-card">
        <h2>ğŸ“‹ åŸå§‹æ•°æ®æŸ¥çœ‹</h2>
        <button onclick="viewRawData()">æŸ¥çœ‹æ‰€æœ‰åŸå§‹æ•°æ®</button>
        <div id="rawDataResult"></div>
    </div>

    <script>
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            container.appendChild(div);
        }

        function clearContainer(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function quickFix() {
            clearContainer('quickFixResult');
            log('quickFixResult', 'ğŸ”§ å¼€å§‹å¿«é€Ÿä¿®å¤...', 'info');
            
            try {
                // 1. ç¡®ä¿æœ‰ç®¡ç†å‘˜è´¦å·
                let users = JSON.parse(localStorage.getItem('all_users') || '[]');
                let admin = users.find(u => u.role === 'admin');
                
                if (!admin) {
                    log('quickFixResult', 'åˆ›å»ºç®¡ç†å‘˜è´¦å·...', 'info');
                    admin = {
                        id: 1,
                        username: 'admin',
                        email: 'admin@example.com',
                        password: 'admin123',
                        role: 'admin',
                        registerTime: new Date().toLocaleString('zh-CN'),
                        balance: 10000,
                        level: 'SVIP',
                        twoFactorEnabled: false,
                        emailVerified: true,
                        loginAttempts: 0
                    };
                    users.push(admin);
                    localStorage.setItem('all_users', JSON.stringify(users));
                    log('quickFixResult', 'âœ… ç®¡ç†å‘˜è´¦å·å·²åˆ›å»º', 'success');
                } else {
                    log('quickFixResult', 'âœ… ç®¡ç†å‘˜è´¦å·å·²å­˜åœ¨', 'success');
                }

                // 2. ç¡®ä¿å¯†ç æ­£ç¡®
                if (admin.password !== 'admin123') {
                    admin.password = 'admin123';
                    localStorage.setItem('all_users', JSON.stringify(users));
                    log('quickFixResult', 'âœ… ç®¡ç†å‘˜å¯†ç å·²é‡ç½®ä¸º admin123', 'success');
                }

                // 3. æ¸…é™¤ç™»å½•é™åˆ¶
                admin.loginAttempts = 0;
                localStorage.setItem('all_users', JSON.stringify(users));
                log('quickFixResult', 'âœ… ç™»å½•é™åˆ¶å·²æ¸…é™¤', 'success');

                // 4. æ¸…é™¤å®¡è®¡æ—¥å¿—ä¸­çš„é”™è¯¯è®°å½•
                let auditLogs = JSON.parse(localStorage.getItem('audit_logs') || '[]');
                const originalCount = auditLogs.length;
                auditLogs = auditLogs.filter(log => !(log.username === 'admin' && log.action === 'login_failed'));
                localStorage.setItem('audit_logs', JSON.stringify(auditLogs));
                log('quickFixResult', `âœ… æ¸…é™¤äº† ${originalCount - auditLogs.length} æ¡å¤±è´¥æ—¥å¿—`, 'success');

                // 5. æ¸…é™¤å½“å‰ç”¨æˆ·ä¼šè¯
                localStorage.removeItem('user_token');
                localStorage.removeItem('user_data');
                log('quickFixResult', 'âœ… æ¸…é™¤äº†ç°æœ‰ä¼šè¯', 'success');

                log('quickFixResult', 'ğŸ‰ å¿«é€Ÿä¿®å¤å®Œæˆï¼ç°åœ¨å°è¯•ç™»å½•:', 'success');
                log('quickFixResult', 'ç”¨æˆ·å: admin', 'success');
                log('quickFixResult', 'å¯†ç : admin123', 'success');

            } catch (error) {
                log('quickFixResult', `âŒ ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function runFullDiagnostic() {
            clearContainer('diagnosticResult');
            log('diagnosticResult', 'ğŸ” å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');
            
            try {
                // æ£€æŸ¥1: localStorage æ˜¯å¦å¯ç”¨
                if (typeof(Storage) !== "undefined") {
                    log('diagnosticResult', 'âœ… localStorage å¯ç”¨', 'success');
                } else {
                    log('diagnosticResult', 'âŒ localStorage ä¸å¯ç”¨', 'error');
                    return;
                }

                // æ£€æŸ¥2: ç”¨æˆ·æ•°æ®
                const users = JSON.parse(localStorage.getItem('all_users') || '[]');
                log('diagnosticResult', `ğŸ“Š æ‰¾åˆ° ${users.length} ä¸ªç”¨æˆ·`, 'info');
                
                const admin = users.find(u => u.role === 'admin');
                if (admin) {
                    log('diagnosticResult', `âœ… ç®¡ç†å‘˜è´¦å·å­˜åœ¨: ${admin.username}`, 'success');
                    log('diagnosticResult', `  - ID: ${admin.id}`, 'info');
                    log('diagnosticResult', `  - é‚®ç®±: ${admin.email}`, 'info');
                    log('diagnosticResult', `  - æ˜æ–‡å¯†ç : ${admin.password ? 'æœ‰ (' + admin.password + ')' : 'æ— '}`, admin.password ? 'success' : 'error');
                    log('diagnosticResult', `  - å“ˆå¸Œå¯†ç : ${admin.passwordHash ? 'æœ‰' : 'æ— '}`, 'info');
                    log('diagnosticResult', `  - ç›å€¼: ${admin.passwordSalt ? 'æœ‰' : 'æ— '}`, 'info');
                    log('diagnosticResult', `  - ç™»å½•å°è¯•æ¬¡æ•°: ${admin.loginAttempts || 0}`, 'info');
                } else {
                    log('diagnosticResult', 'âŒ æœªæ‰¾åˆ°ç®¡ç†å‘˜è´¦å·', 'error');
                }

                // æ£€æŸ¥3: å®¡è®¡æ—¥å¿—
                const auditLogs = JSON.parse(localStorage.getItem('audit_logs') || '[]');
                log('diagnosticResult', `ğŸ“‹ å®¡è®¡æ—¥å¿—æ¡æ•°: ${auditLogs.length}`, 'info');
                
                const adminLogs = auditLogs.filter(log => log.username === 'admin');
                if (adminLogs.length > 0) {
                    log('diagnosticResult', `ğŸ“‹ ç®¡ç†å‘˜ç›¸å…³æ—¥å¿—: ${adminLogs.length} æ¡`, 'info');
                    const recentLogs = adminLogs.slice(-3);
                    recentLogs.forEach(logEntry => {
                        const type = logEntry.action.includes('success') ? 'success' : 'error';
                        log('diagnosticResult', `  - ${logEntry.action}: ${JSON.stringify(logEntry.details)}`, type);
                    });
                }

                // æ£€æŸ¥4: å½“å‰ä¼šè¯
                const currentToken = localStorage.getItem('user_token');
                const currentUser = localStorage.getItem('user_data');
                log('diagnosticResult', `ğŸ” å½“å‰ä»¤ç‰Œ: ${currentToken ? 'æœ‰' : 'æ— '}`, 'info');
                log('diagnosticResult', `ğŸ‘¤ å½“å‰ç”¨æˆ·: ${currentUser ? 'æœ‰' : 'æ— '}`, 'info');

                // æ£€æŸ¥5: å…¶ä»–ç›¸å…³æ•°æ®
                const allCards = JSON.parse(localStorage.getItem('all_cards') || '[]');
                const balanceHistory = JSON.parse(localStorage.getItem('balance_history') || '[]');
                log('diagnosticResult', `ğŸ« å¡å¯†æ•°é‡: ${allCards.length}`, 'info');
                log('diagnosticResult', `ğŸ’° ä½™é¢å†å²: ${balanceHistory.length} æ¡`, 'info');

                log('diagnosticResult', 'ğŸ è¯Šæ–­å®Œæˆ', 'success');

            } catch (error) {
                log('diagnosticResult', `âŒ è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
                log('diagnosticResult', `é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }

        function simulateLogin() {
            clearContainer('simulationResult');
            log('simulationResult', 'ğŸ§ª å¼€å§‹æ¨¡æ‹Ÿç™»å½•æµç¨‹...', 'info');
            
            try {
                const credentials = {
                    username: 'admin',
                    password: 'admin123'
                };

                log('simulationResult', `1ï¸âƒ£ è¾“å…¥å‡­æ®: ${credentials.username} / ${credentials.password}`, 'info');

                // æ­¥éª¤1: ç”¨æˆ·åéªŒè¯
                const isAdminLogin = credentials.username.toLowerCase() === 'admin';
                log('simulationResult', `2ï¸âƒ£ æ˜¯å¦ä¸ºç®¡ç†å‘˜ç™»å½•: ${isAdminLogin}`, isAdminLogin ? 'success' : 'info');

                if (!isAdminLogin) {
                    // æ¨¡æ‹Ÿç”¨æˆ·åéªŒè¯é€»è¾‘
                    const errors = [];
                    if (!credentials.username || credentials.username.length < 3) {
                        errors.push('ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦');
                    }
                    if (credentials.username.length > 20) {
                        errors.push('ç”¨æˆ·åä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
                    }
                    if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(credentials.username)) {
                        errors.push('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡');
                    }
                    const forbiddenWords = ['root', 'system', 'test', 'ç®¡ç†å‘˜'];
                    if (forbiddenWords.some(word => credentials.username.toLowerCase().includes(word))) {
                        errors.push('ç”¨æˆ·ååŒ…å«ç¦ç”¨è¯æ±‡');
                    }

                    if (errors.length > 0) {
                        log('simulationResult', `âŒ ç”¨æˆ·åéªŒè¯å¤±è´¥: ${errors.join(', ')}`, 'error');
                        return;
                    }
                }
                log('simulationResult', 'âœ… ç”¨æˆ·åéªŒè¯é€šè¿‡', 'success');

                // æ­¥éª¤2: æŸ¥æ‰¾ç”¨æˆ·
                const users = JSON.parse(localStorage.getItem('all_users') || '[]');
                const foundUser = users.find(u => u.username === credentials.username);
                
                if (!foundUser) {
                    log('simulationResult', 'âŒ ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                    return;
                }
                log('simulationResult', 'âœ… ç”¨æˆ·æ‰¾åˆ°', 'success');

                // æ­¥éª¤3: å¯†ç éªŒè¯
                let isPasswordValid = false;
                
                // é¦–å…ˆå°è¯•æ˜æ–‡å¯†ç éªŒè¯
                if (foundUser.password) {
                    isPasswordValid = foundUser.password === credentials.password;
                    log('simulationResult', `3ï¸âƒ£ æ˜æ–‡å¯†ç éªŒè¯: ${isPasswordValid ? 'é€šè¿‡' : 'å¤±è´¥'}`, isPasswordValid ? 'success' : 'error');
                    log('simulationResult', `   ç”¨æˆ·å¯†ç : "${foundUser.password}"`, 'info');
                    log('simulationResult', `   è¾“å…¥å¯†ç : "${credentials.password}"`, 'info');
                }

                // å¦‚æœæ˜æ–‡å¯†ç éªŒè¯å¤±è´¥ï¼Œå°è¯•å“ˆå¸ŒéªŒè¯
                if (!isPasswordValid && foundUser.passwordHash && foundUser.passwordSalt) {
                    log('simulationResult', 'å°è¯•å“ˆå¸Œå¯†ç éªŒè¯...', 'info');
                    // è¿™é‡Œæˆ‘ä»¬æ— æ³•çœŸæ­£éªŒè¯å“ˆå¸Œï¼Œå› ä¸ºéœ€è¦crypto-jsåº“
                    log('simulationResult', 'âš ï¸ å“ˆå¸ŒéªŒè¯éœ€è¦åœ¨å®é™…åº”ç”¨ä¸­è¿›è¡Œ', 'warning');
                }

                if (!isPasswordValid) {
                    log('simulationResult', 'âŒ å¯†ç éªŒè¯å¤±è´¥', 'error');
                    return;
                }

                log('simulationResult', 'âœ… å¯†ç éªŒè¯é€šè¿‡', 'success');
                log('simulationResult', 'ğŸ‰ æ¨¡æ‹Ÿç™»å½•æˆåŠŸï¼', 'success');
                log('simulationResult', 'â¡ï¸ è¯·åœ¨å®é™…åº”ç”¨ä¸­æµ‹è¯•ç™»å½•', 'info');

            } catch (error) {
                log('simulationResult', `âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function viewRawData() {
            clearContainer('rawDataResult');
            log('rawDataResult', 'ğŸ“‹ æŸ¥çœ‹åŸå§‹æ•°æ®...', 'info');
            
            try {
                const data = {
                    all_users: JSON.parse(localStorage.getItem('all_users') || '[]'),
                    user_token: localStorage.getItem('user_token'),
                    user_data: JSON.parse(localStorage.getItem('user_data') || '{}'),
                    audit_logs: JSON.parse(localStorage.getItem('audit_logs') || '[]').slice(-10),
                    all_cards: JSON.parse(localStorage.getItem('all_cards') || '[]').length,
                    balance_history: JSON.parse(localStorage.getItem('balance_history') || '[]').length
                };

                const container = document.getElementById('rawDataResult');
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                container.appendChild(pre);

            } catch (error) {
                log('rawDataResult', `âŒ æŸ¥çœ‹æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function resetEverything() {
            if (!confirm('âš ï¸ è¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®å¹¶é‡æ–°åˆå§‹åŒ–ç³»ç»Ÿï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            clearContainer('quickFixResult');
            log('quickFixResult', 'ğŸ”„ å¼€å§‹å®Œå…¨é‡ç½®...', 'warning');

            try {
                // æ¸…ç©ºæ‰€æœ‰æ•°æ®
                localStorage.clear();
                log('quickFixResult', 'âœ… æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…é™¤', 'success');

                // é‡æ–°åˆ›å»ºç®¡ç†å‘˜è´¦å·
                const admin = {
                    id: 1,
                    username: 'admin',
                    email: 'admin@example.com', 
                    password: 'admin123',
                    role: 'admin',
                    registerTime: new Date().toLocaleString('zh-CN'),
                    balance: 10000,
                    level: 'SVIP',
                    twoFactorEnabled: false,
                    emailVerified: true,
                    loginAttempts: 0
                };

                localStorage.setItem('all_users', JSON.stringify([admin]));
                log('quickFixResult', 'âœ… ç®¡ç†å‘˜è´¦å·å·²é‡æ–°åˆ›å»º', 'success');

                // åˆ›å»ºä¸€äº›æµ‹è¯•å¡å¯†
                const testCards = [];
                for (let i = 1; i <= 5; i++) {
                    testCards.push({
                        id: i,
                        cardNumber: `TEST${Date.now()}${i.toString().padStart(3, '0')}`,
                        cardType: 'æœˆå¡',
                        value: 'Â¥29.90',
                        status: 'unused',
                        createTime: new Date().toLocaleString('zh-CN'),
                        useTime: null,
                        expireTime: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN')
                    });
                }
                localStorage.setItem('all_cards', JSON.stringify(testCards));
                log('quickFixResult', 'âœ… æµ‹è¯•å¡å¯†å·²åˆ›å»º', 'success');

                log('quickFixResult', 'ğŸ‰ ç³»ç»Ÿé‡ç½®å®Œæˆï¼', 'success');
                log('quickFixResult', 'ç°åœ¨å¯ä»¥ä½¿ç”¨ admin/admin123 ç™»å½•', 'success');
                log('quickFixResult', 'âš ï¸ è¯·åˆ·æ–°ä¸»åº”ç”¨é¡µé¢', 'warning');

            } catch (error) {
                log('quickFixResult', `âŒ é‡ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.onload = function() {
            setTimeout(() => {
                runFullDiagnostic();
            }, 500);
        };
    </script>
</body>
</html>